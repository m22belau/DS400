---
title: "NHANES Challenge"
format: html
editor: visual
---

### Load Libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(car)
library(tidyverse)
library(haven)
library(here)
library(ggplot2)
library(janitor)
library(scales)
```

### Read-in Datasets for this Analysis:

-   DR1TOT_J.xpt as 'diet_behavior'
-   2017-2018_Hg-Blood.XPT as 'blood_hg'
-   2017-2018_Hg-Urine.XPT as 'urine_hg'
-   2017-2018_Diabetes.XPT as 'diabetes'

```{r}
diet_behavior <- read_xpt(here("nhanes_data/DR1TOT_J.XPT"))
blood_hg      <- read_xpt(here("nhanes_data/2017-2018_Hg-Blood.XPT"))
urine_hg      <- read_xpt(here("nhanes_data/2017-2018_Hg-Urine.XPT"))
diabetes      <- read_xpt(here("nhanes_data/2017-2018_Diabetes.XPT"))
demographics  <- read_xpt(here("nhanes_data/2017-2018_Demographics.XPT"))
```

### Subset Read-in Datasets

Subset 'diet_behavior' as 'diet'

```{r}
diet <- select(diet_behavior, SEQN, DRD360, DRD370B, DRD370BQ, DRD370Q, DRD370QQ)
```

Subset 'diabetes' as 'tiid'

```{r}
tiid <- select(diabetes, SEQN, DIQ010, DIQ170)
```

Subset 'blood_hg' as 'bhg'

```{r}
bhg <- select(blood_hg, SEQN, LBXIHG, LBDIHGSI, LBXBGE, LBXBGM)
```

Subset "urine_hg' as 'uhg'

```{r}
uhg <- select(urine_hg, SEQN, URXUHG)
```

### Merge Subsets Into A Working Dataframe as 'df'

```{r}
df <- list(diet, tiid, bhg, uhg)

df <- df %>% reduce(full_join, by = 'SEQN')
```

1.  Filter Dataframe df for the following:

```{r}
# Assuming your dataframe is named `nhanes_data`
df <- df %>%
  # Filter out rows where DIQ010 or DRD360 are NA
  filter(!is.na(DIQ010), !is.na(DRD370B)) %>%
  # Keep only rows where DIQ010 and DRD360 are 1 or 2
  filter(DIQ010 %in% c(1, 2), DRD370B %in% c(1, 2)) %>%
  # Recode 1 to "Yes" and 2 to "No" for DIQ010 and DRD360
  mutate(
    DIQ010 = ifelse(DIQ010 == 1, "Has Diabetes", "No Diabetes"),
    DRD370B = ifelse(DRD370B == 1, "Consumes Ahi", "No Ahi")
  )
  
```

2.  Do some exploratory data analysis

```{r}
##Bar Plot 
ggplot(df, aes(x = DRD370B, fill = DIQ010)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent_format()) +
  labs(
    title = "Proportion of Diabetes Status by Ahi Consumption",
    x = "Ahi Consumption",
    y = "Percentage"
  ) +
  theme_minimal()

##Boxplot of Urine Mercury by Diabetes Status

ggplot(df, aes(x = DIQ010, y = URXUHG, fill = DIQ010)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Urine Mercury Levels by Diabetes Status",
    x = "Diabetes Status",
    y = "Urine Mercury (µg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")


##Boxplot of Blood Mercury by Diabetes Status
ggplot(df, aes(x = DIQ010, y = LBXIHG, fill = DIQ010)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Blood Mercury Levels by Diabetes Status",
    x = "Diabetes Status",
    y = "Blood Mercury (µg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

```{r}
# P(B) = proportion with diabetes
p_B <- mean(df$DIQ010 == "Has Diabetes")
p_B
```

```{r}
# P(A) = proportion that eats tuna
p_A <- mean(df$DRD370B == "Consumes Ahi")
p_A
```

```{r}
# P(A|B) = proportion of tuna eaters among diabetics
p_A_given_B <- mean(df$DRD370B[df$DIQ010 == "Has Diabetes"] == "Consumes Ahi")
p_A_given_B
```

```{r}
p_B_given_A <- (p_A_given_B * p_B) / p_A
p_B_given_A
```

2.  Determine the prior probability that someone has diabetes (DIQ010)
    -   P(B) 0.1287574
3.  Determine the prior probability that someone eats tuna (DRD370B)
    -   P(A) 0.3609467
4.  Determine the likelihood of eating tuna and having diabetes
    -   L(B\|A) = P(A\|B) 0.3584559
5.  Determine posterior probability via bayes theorem
    -   P(B\|A) 0.1278689
6.  What other questions can we ask of this data?

Reverse the condition: What is the probability that someone eats tuna given they do not have diabetes?

Demographic breakdowns: Does the diabetes-tuna relationship differ by sex, age group, or ethnicity (from your demographics dataset?

#### Bayes Theorem

$$
P(B \mid A) = \frac{P(B) L(B \mid A)}{P(A)} 
$$

B \<- Has Diabetes

A \<- Consumes Ahi

#### 

### Challenge

Determine the posterior probability that someone has diabetes given they are over the age of 40. Age is in the demographics dataframe, you will have to join it with the tiid data.

```         
0.2294858
The posterior probability that someone has diabetes given they are over 40 is ≈ 22.95%. 1 in 5 adults over 40 in this dataset report having diabetes.
```

```{r}
demo_age <- demographics %>%
  select(SEQN, RIDAGEYR)

df_age <- tiid %>%
  left_join(demo_age, by = "SEQN") %>%
  filter(!is.na(DIQ010), DIQ010 %in% c(1, 2)) %>%
  mutate(
    DIQ010 = ifelse(DIQ010 == 1, "Has Diabetes", "No Diabetes"),
    over40 = ifelse(RIDAGEYR > 40, "Over 40", "40 or younger")
  )

# Posterior probability: Diabetes given age > 40
p_B_given_age40 <- mean(df_age$DIQ010[df_age$over40 == "Over 40"] == "Has Diabetes")
p_B_given_age40

```
